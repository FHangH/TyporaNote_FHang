# C++_面向对象反汇编补充



### 1. 类



#### 1.1 类的定义

- C++中可以使用 `struct`，`class`来定义类



#### 1.2 struct和class区别



- `struct`默认成员权限是`public`
- `class`默认成员权限是`private`



##### 1.2.1 定义和访问



- 代码示例：

  ```c++
  struct Person
  {
      int m_Age;
      
      void run()
      {
          cout << "m_Age: " << m_Age << endl;
      }
  };
  
  class Person
  {
  public:    
      int m_Age;
      
      void run()
      {
          cout << "m_Age: " << m_Age << endl;
      }
  };
  
  Person person;
  // 通过对象访问
  person.m_Age = 20;
  person.run();
  
  // 通过指针访问
  Person *ptr_Person = &person;
  ptr_Person ->m_Age = 20;
  ptr_Person ->run();
  ```

- `对象person` 和 `指针ptr_Person`的内存都是在函数的栈空间中，自动分配和回收

- `对象person`只有一个`int类型`的成员变量，所以是`4字节`

- `指针ptr_Person`在 `32位`占用`4字节`，`64位`占用`8字节`







##### 1.2.2 反汇编查看区别



- 代码示例1：

  ```c++
  class Car
  {
  public:
      int m_price;
      
      void run()
      {
          cout << "Car::run() " << m_price << endl;
      }
  };
  
  int main()
  {
      Car car1;
      car1.m_price = 10;
      car1.run();
      
      Car car2;
      car2.m_price = 20;
      car2.run();
      
      return 0;
  }
  ```

  ```assembly
  // 查看核心部分汇编代码
  
  mov dword ptr[car1], 0Ah // 由此可得，对象占用4字节，成员变量占用4字节，所以第一个成员变量的内存地址就是对象的地址
  // Car car1;
  // car1.m_price = 10;
  
  lea ecx, [car1]
  call 0086141A // 此处 call run()
  // car1.run();
      
  mov dword ptr[car2], 14h
  // Car car2;
  
  lea ecx, [car2]
  call 0086141A // 此处 call run()
  // car2.m_price = 20;
  // car2.run();
  
  // 由上可以等到，两个对象 car1 和 car2 的成员变量是不同的
  // 但它们调用的函数的地址是同一个
  ```

- 对象内的函数不占用对象的内存大小：

  - 类中的函数在编译阶段，会将函数的地址存放到单独的一段内存中
  - 当两个函数完全相同时，会去重，仅保留一个函数地址
  - 一个类生成的多个对象中，只有成员变量是每个对象各自拥有的，而成员方法则是统一去重存储在`方法列表`中

- 补充：

  - 无论函数和变量存在于什么地方，如果没有在其它地方使用或调用
  - 该函数和变量，在编译阶段会被优化，也就是根本不存在







#### 1.3 对象的内存布局



- 代码示例：

  ```c++
  struct Person
  {
    int m_age;
    int m_id;
  };
  
  int main()
  {
      Person person;
      person.m_age = 10;
      person.m_id = 100;
      
      cout << "&person = " << &person << endl;
      cout << "&person.m_age = " << &person.m_age << endl;
      cout << "&person.m_id = " << &person.m_id << endl;
      return 0;
  }
  ```

- 运行结果：

  ```powershell
  &person = 0x7bfe18
  &person.m_age = 0x7bfe18   
  &person.m_id = 0x7bfe1c  
  ```

  